<!DOCTYPE html>
<html data-bs-theme="dark">
  <head>
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/themes/smoothness/jquery-ui.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>

    <!-- Other stuff -->
    <script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.alphanum/1.0.24/jquery.alphanum.min.js"></script>
    <script src="js/typeahead.bundle.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
  </head>
  <body>

    <script type="importmap">
    {
      "imports": {
        "@popperjs/core": "https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/esm/popper.min.js",
        "bootstrap": "https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.esm.min.js"
      }
    }
    </script>
    <script type="module">
      import { Octokit, App } from "https://esm.sh/octokit";
      import { restEndpointMethods } from "https://esm.sh/@octokit/plugin-rest-endpoint-methods";
      import * as bootstrap from "bootstrap";


      var repos = []; // <-- Add here more repos, added by the user
      var selectedRepo = null;
      var database = [];
      var selections = [];
      var currentSongList = [];


      async function init(){
        // We don't need auth for the stuff we will be doing here...
        // const octokit = new Octokit();
        $("#loadingOverlay").removeClass("d-none");


        // TODO: GET THE EXTRA REPOS FROM THE USER'S COOKIES
        var userRepos = ["CristobalPenaloza/Z64PackerTestRepo/main", "CristobalPenaloza/OoT-Custom-Sequences/z64"]; // <-- TODO: SHOULDN'T WE ADD HERE THE AVATAR AND STUFF?
        repos = [];

        // Load the properties from each repo
        // We do this every time, to always have the latest version of each one
        await Promise.all(userRepos.map(async (userRepo) => {
          var userRepoSplitted = userRepo.split("/");
          var owner = userRepoSplitted[0];
          var repo = userRepoSplitted[1];
          var defaultBranch = userRepoSplitted[2];

          // Get the z64musicpacker.properties from this repo
          // https://raw.githubusercontent.com/CristobalPenaloza/Z64PackerTestRepo/main/z64musicpacker.properties
          var z64PropertiesLink = `https://raw.githubusercontent.com/${owner}/${repo}/${defaultBranch}/z64musicpacker.properties`;
          var propertiesResponse = await fetch(z64PropertiesLink);

          if(propertiesResponse.ok){
            // Read the file
            var properties = await propertiesResponse.json();
            console.log(properties);
            console.log(propertiesResponse);

            // Load the repo into our list
            repos.push({
              repoName: repo,
              repoOwner: owner,
              repoDefaultBranch: defaultBranch,

              // Import Z64 music packer properties
              ...properties,
            });
          }
        }));

        
        // TODO: ADD THE REPOS TO THE MAIN SELECT
        repos.forEach((repo, i) => {
          $("#panelRepoSelection").append(
            `<button type="button" class="btn btn-outline-light w-100 mb-3" id="btnSelectRepo${i}">
              <div class="row">
                <img class="rounded-circle ml-3 col-auto" width="45" height="45" src="${repo.avatarUrl}" />
                <div class="col text-start">
                  <h5 class="mb-0">${repo.name}</h5>
                  <span class="opacity-500">${repo.description}</span>
                </div>
              </div>
            </button>`
          );
          $(`#btnSelectRepo${i}`).on("click", function(){
            selectedRepo = repo;
            loadRepo();
          });
        });
        
        // TODO: SELECT THE FIRST REPO
        // TODO: SELECT ALSO THE LAST REPO USED BY THE USER (STORED IN COOKIE)
        selectedRepo = repos[0];

        await loadRepo();
        $("#loadingOverlay").addClass("d-none");
      }


      async function loadRepo(){
        $("#loadingOverlay").removeClass("d-none");

        // Set the main selector
        $("#imgRepoAvatar").attr("src", selectedRepo.avatarUrl);
        $("#lbRepoName").text(selectedRepo.name);

        // Get the database from the current repo
        var dbLink = `https://raw.githubusercontent.com/${selectedRepo.repoOwner}/${selectedRepo.repoName}/${selectedRepo.repoDefaultBranch}/${selectedRepo.database}`;
        var dbResponse = await fetch(dbLink);

        if(dbResponse.ok){
          // Load the database
          database = await dbResponse.json();
          database.forEach((item, i) => {
            // We will use an index to map quickly. But when we want to export/import, we will use the uuid.
            item.index = i;
          });
          console.log(database);
          
          // Show the list of games to the user
          loadGamesList();

          // We finish the loading
          $("#loadingOverlay").addClass("d-none");

          // Close the repo selection modal if it's open
          var modalRepoSelection = bootstrap.Modal.getInstance('#modalRepoSelection');    
          modalRepoSelection?.hide();
        }
      }


      function loadGamesList(){
        $("#panelGames").empty();

        // Get the games list, with no dupes
        var games = [...new Set(database.map(s => s.game))].sort();
        games.forEach((game, i) => {
          var songsOfGame = database.filter(s => s.game == game);
          var songsChecked = songsOfGame.filter(s => selections.includes(s.index));
          var checkState = songsChecked.length == 0 ? "" : (songsChecked.length >= songsOfGame.length ? "checked" : "indeterminate");
          
          // Append the game nav item
          $("#panelGames").append(
            `<div class="btn-game row g-0" id="btnGame${i}" data-game="${game}">
              <input class="form-check-input col-auto" type="checkbox" value="" id="cbxGame${i}" ${checkState}/>
              <span class="col ms-3">${game}</span>
              <span class="col-auto me-4">${songsChecked.length}/${songsOfGame.length}</span>
            </div>`
          );

          // Set the current state of the checkbox (we do it like this for the intermediate stuff)
          if(checkState != "") $(`#cbxGame${i}`).prop(checkState, true);

          // Add handlers for the inputs
          $(`#btnGame${i}`).on("click", function(){
            loadSongsList(songsOfGame);
          });
          $(`#cbxGame${i}`).on("click", function(e){
            e.stopPropagation(); // We don't want to hit the button underneath...
            var songIndices = database.filter((s) => s.game == game).map((s) => s.index);
            if(this.checked) selections.push(...songIndices);
            else selections = selections.filter((s) => !songIndices.includes(s));
            updateSelections();
          });
        });
      }
      function loadSongsList(songs){
        currentSongList = songs;
        var games = [...new Set(songs.map(s => s.game))];

        // Cleanup the panel and select the games selected for this song list
        $("#panelSongs").empty();
        $(".btn-game").removeClass("active");
        $("#lbTitleSongs").text(games.join(", "));
        games.forEach(game => $(`.btn-game[data-game="${game}"]`).addClass("active"));

        // Show the song list to the user
        songs.sort((a, b) => a.song.localeCompare(b.song)).forEach((s, i) => {

          // Get the values from the song
          var isOOTRS = s.file.toLowerCase().endsWith(".ootrs");
          var categories = toArray(s.categories).map((c) => 
            `<span class="badge rounded-pill border">${isOOTRS ? c : mmrsCategoryToText(c)}</span>`
          );
          var isSelected = selections.includes(s.index);
          var hasPreview = !! s.preview; // <-- We check if the preview exists first

          $("#panelSongs").append(
            `<div class="col-3">
              <div class="card btn-song ${isSelected ? "active" : ""}" id="btnSong${i}" data-song="${s.uuid}">
                <b>${s.song}<i id="btnPreview${i}" class="fa-solid fa-play ${hasPreview ? "" : "opacity-25"}" style="float: right; margin-top: 5px"></i></b>
                <div class='metadata border-top mt-2 pt-2'>
                  <span><i class="fa-solid fa-music fa-fw"></i> ${toArray(s.composers).join(", ") || "<span class='opacity-50'>Unknown</span>"}</span><br>
                  <span><i class="fa-solid fa-wave-square fa-fw"></i> ${toArray(s.converters).join(", ") || "<span class='opacity-50'>Unknown</span>"}</span>
                </div>
                <div class='categories border-top mt-2 pt-2 row g-1'>
                  <i class="fa-solid fa-tag fa-fw col-auto pt-1"></i>
                  <div class='col mt-0'>${categories.join(" ")}</div>
                </div>
                <span class="format border-top mt-2 pt-2">
                  <i class="fa-solid fa-file-audio fa-fw"></i> <span class='opacity-50'>${isOOTRS ? "OOTRS" : "MMRS"}
                  ${s.usesCustomBank ? (" custom bank" + (s.usesCustomSamples ? " and samples" : "")) : " vanilla bank"}</span>
                </span>
              </div>
            </div>`
          );
          $(`#btnSong${i}`).on("click", function(){
            if(isSelected) selections = selections.filter(sel => sel != s.index);
            else selections.push(s.index);
            updateSelections();
          });
          if(hasPreview) $(`#btnPreview${i}`).on("click", function(event){
            event.stopPropagation();
            previewSong(s);
          });
        });
      }


      function mmrsCategoryToText(category){
        switch(category){
          case "0": return "Fields";
          case "1": return "Towns";
          case "2": return "Dungeons";
          case "3": return "Indoors";
          case "4": return "Minigame";
          case "5": return "Action events";
          case "6": return "Calm events";
          case "7": return "Boss fights";
          case "8": return "Item get";
          case "9": return "Game over";
          case "10": return "Area clear";
          case "16": return "Special";
          default: return "Unknown";
        }
      }

      function toArray(v){
        if(Array.isArray(v)) return v;
        else if(typeof v === 'string') return v.split(',').map(x => x.trim()).filter(x => x);
        else return [];
      }


      function previewSong(song){
        var preview = song.preview;
        $("#lbTitleSongPreview").text(song.game + " - " + song.song);
        $("#panelAudioPreview, #panelYouTubePreview").addClass("d-none");

        // Stop the current song
        stopPreview();

        // If it's a YouTube link, we load it as an embed
        if(preview.startsWith("https://www.youtube.com") || preview.startsWith("https://youtu.be")){
          var regExp = /^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
          var match = preview.match(regExp);

          if (match && match[2].length == 11) {
            var videoId = match[2];
            $("#ytpSongPreview").attr("src", "https://www.youtube.com/embed/" + videoId + "?autoplay=1");
            $("#panelYouTubePreview").removeClass("d-none");
            
          } else {
            alert("An error ocurred while processing a YouTube link.\n\nThe link could be corrupted or invalid.");
          }

        } else{
          // If it's a Discord file, use a proxy to renew the access token
          // Shouts out to Serinamoe on Reddit for providing this proxy! Thank you so much!
          if(preview.startsWith("https://cdn.discordapp.com")){
            preview = preview.replace("https://cdn.discordapp.com", "https://cdn.discordapp.xyz");
          }

          // Load the preview
          $("#asrcSongPreview").attr("src", preview);

          // Reload the audio player
          var audioPlayer = $("#apSongPreview")[0];
          audioPlayer.load();
          audioPlayer.play();
          $("#panelAudioPreview").removeClass("d-none");
        }

        // Show the modal
        var modalSongPreview = new bootstrap.Modal('#modalSongPreview', {});
        modalSongPreview.show();
      }
      function stopPreview(){
        $("#ytpSongPreview").attr("src", "");
        $("#apSongPreview")[0].pause();
      }


      function updateSongViewOptions(){
        $("#panelSongs").toggleClass("hide-metadata", !$("#cbxViewMetadata").is(":checked"));
        $("#panelSongs").toggleClass("hide-categories", !$("#cbxViewCategories").is(":checked"));
        $("#panelSongs").toggleClass("hide-format", !$("#cbxViewFormat").is(":checked"));
      }
      function updateSelections(){
        // Make sure there is no duplicates
        selections = [...new Set(selections)];

        // Reload the lists
        loadGamesList();
        loadSongsList(currentSongList);

        // Also update the select all
        var allSelections = $("input[id^='cbxGame']").length;
        var currentCheckedSelections = $("input[id^='cbxGame']:checked").length;
        var currentIndeterminateSelections = $("input[id^='cbxGame']:indeterminate").length;
        var checkState = (currentIndeterminateSelections + currentCheckedSelections) == 0 ? "" : (currentCheckedSelections >= allSelections ? "checked" : "indeterminate");
        $("#cbxSelectAll").prop("checked", false).prop("indeterminate", false).prop(checkState, true);
      }


      async function downloadSongPack(){
        console.log(selections);

        // Create the archive
        $("#loadingOverlay").removeClass("d-none");
        var zip = new JSZip();

        // Fetch the full binaries.zip file
        var binariesLink = `https://raw.githubusercontent.com/${selectedRepo.repoOwner}/${selectedRepo.repoName}/${selectedRepo.repoDefaultBranch}/binaries.zip`;
        var binariesResponse = await fetch(binariesLink);

        if(binariesResponse.ok){
          var binaries = await new JSZip().loadAsync(await binariesResponse.blob());
          console.log(binaries);

          // Loop every selection
          for(var songIndex of selections){
            var song = database[songIndex];

            // Grab the song from our binaries file
            var file = binaries.file(`${selectedRepo.binaries}/${song.file}`.replace("//", "/"));

            // Add the file to the final zip pack
            var extension = song.file.split('.').pop();
            var fileName = `${song.game} - ${song.song}.${extension}`;
            zip.file(fileName, await file.async("blob"));

            // Download the song from the github repository (OLD fetch version | Changed because slow)
            /*var fileLink = `https://raw.githubusercontent.com/${selectedRepo.repoOwner}/${selectedRepo.repoName}/${selectedRepo.repoDefaultBranch}/${selectedRepo.binaries}/${song.file}`;
            var fileResponse = await fetch(fileLink);
            console.log(fileLink);

            if(fileResponse.ok){
              // Add the thing to the archive
              var extension = song.file.split('.').pop();
              var fileName = `${song.game} - ${song.song}.${extension}`;
              zip.file(fileName, await fileResponse.blob());
            }*/
          }
        }

        // We finally, download the generated zip
        var blob = await zip.generateAsync({ type:"blob" });
        saveAs(blob, "pack.zip");
        $("#loadingOverlay").addClass("d-none");
      }


      $(function(){
        init();
        $("#modalSongPreview").on("hide.bs.modal", stopPreview);
        $("#cbxViewMetadata, #cbxViewCategories, #cbxViewFormat").on("change", updateSongViewOptions);
        $("#btnDownloadSongPack").on("click", downloadSongPack);

        $("#cbxSelectAll").on("change", function(){
          var checkedState = this.checked;
          // To "select all", we do it with the current applied filter, to not interfere with the other user selections
          $(".btn-game").not(".d-none").each(function(){
            var game = $(this).data("game");
            var songIndices = database.filter((s) => s.game == game).map((s) => s.index);
            if(checkedState) selections.push(...songIndices);
            else selections = selections.filter((s) => !songIndices.includes(s));
          });
          updateSelections();
        });
      });
    </script>



    <style>
      .loading-overlay {
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        color: var(--bs-primary-text-emphasis);
        background-color: rgba(24, 24, 24, .6);
        z-index: 5600;
      }
      .loading-overlay i{
        position: absolute;
        top: 47%;
        left: 47%;
      }

      .btn-game{
        color: var(--nav-lateral-text);
        width: 100%;
        text-decoration: none;
        padding: 10px 0 10px 20px;
        transition: .1s;
        cursor: pointer;
      }
      .btn-game:hover{
        color: var(--bs-primary-text-emphasis);
        background-color: rgba(0,0,0,.2);
      }
      .btn-game.active{
        color: var(--bs-primary-text-emphasis);
        padding-left: 17px;
        background-color: var(--bs-primary-bg-subtle);
        border-left: 3px solid var(--bs-primary-text-emphasis);
      }

      .btn-song{
        padding: .4rem;
        transition: .1s;
        cursor: pointer;
      }
      .btn-song hr{
        margin: .4rem 0;
      }
      .btn-song .badge{
        color: inherit;
      }
      .btn-song.active{
        background-color: var(--bs-primary-bg-subtle);
        border-color: var(--bs-primary-text-emphasis);
      }
      #panelSongs.hide-metadata .metadata{
        display: none;
      }
      #panelSongs.hide-categories .categories{
        display: none;
      }
      #panelSongs.hide-format .format{
        display: none;
      }


      .responsive-iframe {
        position: relative;
        overflow: hidden;
        width: 100%;
        padding-top: 56.25%;
      }
      .responsive-iframe iframe {
        position: absolute;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        width: 100%;
        height: 100%;
      }
    </style>

    
    <div id="loadingOverlay" class="loading-overlay d-none">
      <i class="fa-solid fa-spinner fa-spin-pulse fa-3x"></i>
    </div>

    <nav class="navbar navbar-expand-lg bg-body-tertiary" style="padding-left: 8px; height: 46.5px;">
      <a class="navbar-brand text-secondary" style="width: 242px" href="#">Z64 Song Packer</a>
      <button type="button" data-bs-toggle="modal" data-bs-target="#modalRepoSelection" class="btn btn-outline-light border-0 ms-auto me-3">
        <div class="row g-2">
          <img id="imgRepoAvatar" class="rounded-circle ml-3 col-auto" width="24" height="24" src="" />
          <b class="col mb-0"><span id="lbRepoName">Z64 Test Repo</span> <i class="fa-solid fa-caret-down"></i></b>
        </div>
      </button>
    </nav>

    <div class="container mt-3">
      <div class="row g-3">
        <div class="col-4">
          <div class="card bg-body-tertiary py-3">
            <div class="row g-0 px-3 pb-3 border-bottom">
              <input class="form-check-input col-auto me-3" type="checkbox" id="cbxSelectAll"/>
              <h5 class="col mb-0">Games list:</h5>
              <div class="nav-item dropdown col-auto ms-auto">
                <button id="btnDownload" type="button" class="btn btn-link nav-link dropdown-toggle" data-bs-toggle="dropdown">
                  <i class="fa-solid fa-download"></i>
                </button>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="#" id="btnDownloadSongPack">Download song pack <span class="opacity-50">| ZIP</span></a></li>
                  <li><a class="dropdown-item" href="#" id="btnDownloadSelections">Download selections and preferences <span class="opacity-50">| JSON</span></a></li>
                </ul>
              </div>
            </div>
            <div id="panelGames" class="overflow-y-auto overflow-x-hidden" style="height: calc(100vh - 46.5px - 7.2rem)">
    
            </div>
          </div>
        </div>
  
        <div class="col-8">
          <div class="card bg-body-tertiary py-3">
            <h5 class="ps-3 pb-3 mb-0 border-bottom" id="lbTitleSongs">Songs view</h5>
            <div id="panelSongViewOptions" class="border-bottom py-2 px-3">
              <div class="form-check form-check-inline form-switch">
                <input class="form-check-input" type="checkbox" id="cbxViewMetadata" checked>
                <label class="form-check-label" for="cbxViewMetadata">Show composers/converters</label>
              </div>

              <div class="form-check form-check-inline form-switch">
                <input class="form-check-input" type="checkbox" id="cbxViewCategories" checked>
                <label class="form-check-label" for="cbxViewCategories">Show categories</label>
              </div>

              <div class="form-check form-check-inline form-switch">
                <input class="form-check-input" type="checkbox" id="cbxViewFormat" checked>
                <label class="form-check-label" for="cbxViewFormat">Show file format</label>
              </div>
            </div>
            <div class="overflow-y-auto overflow-x-hidden" style="height: calc(100vh - 46.5px - 9.4rem)">
              <div id="panelSongs" class="row px-3 pt-3 g-2">
    
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- REPO SELECT -->
    <div class="modal fade" id="modalRepoSelection" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5">Select a repository</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center" id="panelRepoSelection">

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>


    <!-- SONG PREVIEW -->
    <div class="modal fade" id="modalSongPreview" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="lbTitleSongPreview">Preview</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <div id="panelAudioPreview">
              <audio controls autoplay id="apSongPreview">
                <source src="" type="audio/mpeg" id="asrcSongPreview">
              </audio>
            </div>
            
            <div id="panelYouTubePreview" class="responsive-iframe">
              <iframe id="ytpSongPreview" type="text/html" width="100%" height="auto" src="" frameborder="0"></iframe>
            </div>
            
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>



  </body>
</html>